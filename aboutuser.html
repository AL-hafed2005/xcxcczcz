<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨ÙŠØ¹</title>
  <link rel="stylesheet" href="style.css">



  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- JsBarcode -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <!-- QuaggaJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
</head>

<body>

  <h2>ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨ÙŠØ¹</h2>

  <!-- Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ù…Ø§Ø³Ø­ -->
  <div style="text-align: center; margin-bottom: 20px;">
    <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬..." oninput="searchItems()" style="padding: 10px; font-size: 16px; width: 300px; border-radius: 8px; border: 1px solid #ccc;" />
    <button onclick="startBarcodeScanner()" style="margin-right: 10px; padding: 10px 15px; font-size: 16px; border-radius: 8px; background-color: #2980b9; color: white; border: none;">ğŸ“· Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
  </div>

  <div id="scanner" style="display: none; margin-bottom: 20px; text-align: center;">
    <video id="barcode-video" width="300" autoplay muted></video>
  </div>

  <ul id="itemsList"></ul>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCnyLJmfaJZAW8c7_LaZo8G63UPWE3M6bs",
      authDomain: "kasher-e52a0.firebaseapp.com",
      projectId: "kasher-e52a0",
      storageBucket: "kasher-e52a0.firebasestorage.app",
      messagingSenderId: "424841509626",
      appId: "1:424841509626:web:9578c33123e2fd6ff0e743",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let globalItems = [];

    function loadItems() {
      db.collection("items").orderBy("timestamp", "desc").get()
        .then(querySnapshot => {
          const list = document.getElementById('itemsList');
          list.innerHTML = '';
          globalItems = [];

          querySnapshot.forEach((doc, index) => {
            const item = doc.data();
            item.id = doc.id;
            item.barcode = (1000 + index).toString();
            globalItems.push(item);
            const li = document.createElement('li');

            li.innerHTML = `
              <div><span class="label">Ø§Ø³Ù…:</span> ${item.name}</div>
              <div><span class="label">Ø§Ù„Ø³Ø¹Ø±:</span> ${item.price}</div>
              <div><span class="label">Ø§Ù„Ø¹Ø¯Ø¯:</span> ${item.quantity}</div>
              <div><span class="label">Ø§Ù„Ø­Ø¬Ù…:</span> ${item.size}</div>
              <div><span class="label">Ø§Ù„Ø¬Ù†Ø³:</span> ${item.gender}</div>
              <svg id="barcode-${index}" class="barcode"></svg>
              <div class="barcode-caption">${item.name}</div>
              <button class="add-to-cart-btn" onclick="addToCart('${item.id}')">ğŸ›’ Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©</button>
              

            `;

            list.appendChild(li);

            JsBarcode(`#barcode-${index}`, item.barcode, {
              format: "CODE128",
              lineColor: "#2980b9",
              width: 2,
              height: 50,
              displayValue: false
            });
          });
        })
        .catch(error => {
          console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ", error);
        });
    }

    function sellItem(id, name) {
      const itemRef = db.collection("items").doc(id);
      itemRef.get().then(doc => {
        if (doc.exists) {
          const item = doc.data();
          let currentQuantity = item.quantity;
          if (currentQuantity > 1) {
            itemRef.update({ quantity: currentQuantity - 1 }).then(() => {
              alert(`ØªÙ… Ø¨ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø¹Ø©: ${name}`);
              loadItems();
            });
          } else {
            itemRef.delete().then(() => {
              alert(`ØªÙ… Ø¨ÙŠØ¹ Ø¢Ø®Ø± Ù‚Ø·Ø¹Ø© Ù…Ù†: ${name} ÙˆØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±`);
              loadItems();
            });
          }
        }
      }).catch(error => {
        console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ¹: ", error);
      });
    }

    function searchItems() {
      const query = document.getElementById("searchInput").value.trim().toLowerCase();
      const items = document.querySelectorAll("#itemsList li");

      items.forEach(item => {
        const name = item.querySelector(".barcode-caption").textContent.toLowerCase();
        item.style.display = name.includes(query) ? "flex" : "none";
      });
    }

    function startBarcodeScanner() {
      const scannerArea = document.getElementById("scanner");
      scannerArea.style.display = "block";

      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#barcode-video'),
          constraints: { facingMode: "environment" }
        },
        decoder: {
          readers: ["code_128_reader"]
        }
      }, function(err) {
        if (err) {
          console.error(err);
          alert("ØªØ¹Ø°Ø± ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
          return;
        }
        Quagga.start();
      });

      Quagga.onDetected(data => {
        const code = data.codeResult.code;
        alert("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: " + code);

        Quagga.stop();
        scannerArea.style.display = "none";

        const found = globalItems.find(item => item.barcode === code);
        if (found) {
          document.getElementById("searchInput").value = found.name;
          searchItems();
        } else {
          alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯");
        }
      });
    }

    window.onload = () => {
      loadItems();
    };

    
  </script>
<script>
  let cart = [];

  function addToCart(itemId) {
    const item = globalItems.find(i => i.id === itemId);
    if (!item) return;

    const existing = cart.find(i => i.id === itemId);
    if (existing) {
      if (existing.selectedQty < item.quantity) {
        existing.selectedQty += 1;
      } else {
        alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù…ØªÙˆÙØ± ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.");
      }
    } else {
      cart.push({ ...item, selectedQty: 1 });
    }
    updateCartDisplay();
  }

  function updateCartDisplay() {
  const cartList = document.getElementById("cartList");
  const totalPriceElement = document.getElementById("totalPrice");
  cartList.innerHTML = "";

  let total = 0;

  cart.forEach(item => {
    const li = document.createElement("li");
    li.textContent = `${item.name} - ${item.price} Ø¯ÙŠÙ†Ø§Ø± Ã— ${item.selectedQty} `;

    // Ø²Ø± Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø¯
    const plusBtn = document.createElement("button");
    plusBtn.textContent = "+";
    plusBtn.onclick = () => {
      if (item.selectedQty < item.quantity) {
        item.selectedQty += 1;
        updateCartDisplay();
      }
    };

    // Ø²Ø± Ø¥Ù†Ù‚Ø§Øµ Ø§Ù„Ø¹Ø¯Ø¯
    const minusBtn = document.createElement("button");
    minusBtn.textContent = "-";
    minusBtn.onclick = () => {
      item.selectedQty -= 1;
      if (item.selectedQty <= 0) {
        cart = cart.filter(i => i.id !== item.id);
      }
      updateCartDisplay();
    };

    // Ø²Ø± Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
    const removeBtn = document.createElement("button");
    removeBtn.textContent = "âŒ";
    removeBtn.style.marginRight = "10px";
    removeBtn.onclick = () => removeFromCart(item.id);

    li.appendChild(plusBtn);
    li.appendChild(minusBtn);
    li.appendChild(removeBtn);
    cartList.appendChild(li);

    total += parseFloat(item.price) * item.selectedQty;
  });

  totalPriceElement.textContent = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${total.toFixed(2)} Ø¯ÙŠÙ†Ø§Ø±`;
}


  function removeFromCart(itemId) {
    cart = cart.filter(item => item.id !== itemId);
    updateCartDisplay();
  }

  function purchaseCart() {
    if (cart.length === 0) {
      alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©.");
      return;
    }

    const confirmPurchase = confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø´Ø±Ø§Ø¡ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±ØŸ");
    if (!confirmPurchase) return;

    const promises = cart.map(item => {
      const itemRef = db.collection("items").doc(item.id);
      return itemRef.get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          if (data.quantity > item.selectedQty) {
            return itemRef.update({ quantity: data.quantity - item.selectedQty });
          } else {
            return itemRef.delete();
          }
        }
      });
    });

    // Ø­ÙØ¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙÙŠ Firestore
const employeeName = document.getElementById("employeeName").value.trim();

if (!employeeName) {
  alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù‚Ø¨Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡.");
  return;
}

const saleData = {
  employee: employeeName,
  items: cart.map(item => ({
    name: item.name,
    price: item.price,
    quantity: item.selectedQty
  })),
  total: cart.reduce((sum, item) => sum + (item.selectedQty * parseFloat(item.price)), 0),
  timestamp: firebase.firestore.FieldValue.serverTimestamp()
};



db.collection("salesReports").add(saleData).then(() => {
  console.log("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­");
}).catch(error => {
  console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:", error);
});

  }
</script>
<script>
function toggleSidebar() {
  var menu = document.getElementById('sidebarMenu');
  menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
}
// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
window.onclick = function(event) {
  var menu = document.getElementById('sidebarMenu');
  var btn = document.querySelector('.dropdown-toggle');
  if (menu && event.target !== btn && !btn.contains(event.target)) {
    menu.style.display = 'none';
  }
}
</script>
  <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
  <div class="sidebar">
    <h1>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹</h1>
    <a href="sale_reports.html" target="_blank" style="position: fixed; left: 20px; bottom: 20px; background-color: #2980b9; color: white; padding: 10px 15px; border-radius: 8px; text-decoration: none;">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</a>
     <a href="index.html" class="btn" style="margin-top:auto;background:#d32f2f;color:#fff;">
      <img src="https://img.icons8.com/ios-filled/32/ffffff/logout-rounded-left.png" alt="ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬"> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
    </a>
  </div>
<hr />
<div id="cartContainer">
  <h3>ğŸ›ï¸ Ø³Ù„Ø© Ø§Ù„Ø´Ø±Ø§Ø¡</h3>
    <label for="employeeName">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù:</label>
  <input type="text" id="employeeName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù" style="margin-bottom: 10px; padding: 5px; border-radius: 5px; border: 1px solid #ccc; display: block;" />
  
  <ul id="cartList"></ul>
  <p id="totalPrice">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: 0 Ø¯ÙŠÙ†Ø§Ø±</p>
  <button onclick="purchaseCart()">Ø´Ø±Ø§Ø¡ Ø§Ù„ÙƒÙ„</button>
</div>

</body>
</html>
